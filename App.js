import React, { useState, useEffect } from 'react';
import {
  StyleSheet,
  Text,
  View,
  ScrollView,
  TextInput,
  TouchableOpacity,
  Alert,
  FlatList,
  Modal,
  Image,
  SafeAreaView,
  StatusBar,
  I18nManager
} from 'react-native';
import { NavigationContainer } from '@react-navigation/native';
import { createStackNavigator } from '@react-navigation/stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';

// ุชูุนูู ุฏุนู RTL ููุบุฉ ุงูุนุฑุจูุฉ
I18nManager.allowRTL(true);
I18nManager.forceRTL(true);

const Stack = createStackNavigator();
const Tab = createBottomTabNavigator();

// ุฎุฏูุฉ API
const API_BASE_URL = 'https://kkh7ikcgy6jm.manus.space/api';

const api = {
  async get(endpoint) {
    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`);
      return await response.json();
    } catch (error) {
      console.error('API Error:', error);
      return [];
    }
  },
  
  async post(endpoint, data) {
    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      return await response.json();
    } catch (error) {
      console.error('API Error:', error);
      return null;
    }
  }
};

// ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู
function LoginScreen({ navigation }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleLogin = () => {
    if (email && password) {
      navigation.navigate('MainTabs');
    } else {
      Alert.alert('ุฎุทุฃ', 'ูุฑุฌู ุฅุฏุฎุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุฉ ุงููุฑูุฑ');
    }
  };

  const handleGuestLogin = () => {
    navigation.navigate('MainTabs');
  };

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar barStyle="dark-content" backgroundColor="#ffffff" />
      <ScrollView contentContainerStyle={styles.loginContainer}>
        <View style={styles.logoContainer}>
          <Text style={styles.logoText}>ุฎุฏูููู</Text>
          <Text style={styles.tagline}>ุดุบูู ุฌุงู ูุนูุฏู</Text>
        </View>

        <View style={styles.formContainer}>
          <Text style={styles.formTitle}>ุชุณุฌูู ุงูุฏุฎูู ุฅูู ุญุณุงุจู</Text>
          
          <View style={styles.inputContainer}>
            <Text style={styles.inputLabel}>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</Text>
            <TextInput
              style={styles.input}
              value={email}
              onChangeText={setEmail}
              placeholder="ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู"
              keyboardType="email-address"
              autoCapitalize="none"
            />
          </View>

          <View style={styles.inputContainer}>
            <Text style={styles.inputLabel}>ูููุฉ ุงููุฑูุฑ</Text>
            <TextInput
              style={styles.input}
              value={password}
              onChangeText={setPassword}
              placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ"
              secureTextEntry
            />
          </View>

          <TouchableOpacity style={styles.loginButton} onPress={handleLogin}>
            <Text style={styles.loginButtonText}>ุชุณุฌูู ุงูุฏุฎูู</Text>
          </TouchableOpacity>

          <TouchableOpacity style={styles.registerButton}>
            <Text style={styles.registerButtonText}>ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</Text>
          </TouchableOpacity>

          <TouchableOpacity style={styles.guestButton} onPress={handleGuestLogin}>
            <Text style={styles.guestButtonText}>ุชุฌุฑุจุฉ ุงูุชุทุจูู (ุจุฏูู ุชุณุฌูู)</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
}

// ุดุงุดุฉ ุงูุฑุฆูุณูุฉ
function HomeScreen({ navigation }) {
  const [posts, setPosts] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [filteredPosts, setFilteredPosts] = useState([]);

  useEffect(() => {
    loadPosts();
  }, []);

  useEffect(() => {
    if (searchQuery) {
      const filtered = posts.filter(post =>
        post.title.includes(searchQuery) ||
        post.service_type.includes(searchQuery) ||
        post.city.includes(searchQuery)
      );
      setFilteredPosts(filtered);
    } else {
      setFilteredPosts(posts);
    }
  }, [searchQuery, posts]);

  const loadPosts = async () => {
    const data = await api.get('/posts');
    setPosts(data);
    setFilteredPosts(data);
  };

  const renderPost = ({ item }) => (
    <View style={styles.postCard}>
      <View style={styles.postHeader}>
        <Text style={styles.postTitle}>{item.title}</Text>
        <Text style={styles.postSalary}>{item.salary}</Text>
      </View>
      
      <Text style={styles.postService}>{item.service_type}</Text>
      <Text style={styles.postLocation}>๐ {item.city}, {item.area}</Text>
      <Text style={styles.postDescription}>{item.description}</Text>
      
      <View style={styles.postFooter}>
        <Text style={styles.postUser}>๐ค {item.user.username}</Text>
        <Text style={styles.postSchedule}>โฐ {item.work_schedule}</Text>
      </View>
      
      <TouchableOpacity style={styles.contactButton}>
        <Text style={styles.contactButtonText}>ุชูุงุตู</Text>
      </TouchableOpacity>
    </View>
  );

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <Text style={styles.headerTitle}>ุฎุฏูููู</Text>
        <Text style={styles.headerSubtitle}>ุงุนุซุฑ ุนูู ุงูุฎุฏูุฉ ุงูููุงุณุจุฉ</Text>
      </View>

      <View style={styles.searchContainer}>
        <TextInput
          style={styles.searchInput}
          value={searchQuery}
          onChangeText={setSearchQuery}
          placeholder="ุงุจุญุซ ุนู ุฎุฏูุฉ ุฃู ูุฏููุฉ..."
        />
      </View>

      <View style={styles.quickActions}>
        <TouchableOpacity 
          style={[styles.actionButton, styles.jobSeekerButton]}
          onPress={() => navigation.navigate('CreatePost')}
        >
          <Text style={styles.actionButtonText}>ุฃุจุญุซ ุนู ุนูู</Text>
        </TouchableOpacity>
        
        <TouchableOpacity style={[styles.actionButton, styles.employerButton]}>
          <Text style={styles.actionButtonText}>ุฃุจุญุซ ุนู ุดุฎุต ููุนูู</Text>
        </TouchableOpacity>
      </View>

      <Text style={styles.sectionTitle}>ุขุฎุฑ ุงูููุดูุฑุงุช</Text>
      
      <FlatList
        data={filteredPosts}
        renderItem={renderPost}
        keyExtractor={(item) => item.id.toString()}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.postsList}
      />
    </SafeAreaView>
  );
}

// ุดุงุดุฉ ุฅูุดุงุก ููุดูุฑ
function CreatePostScreen({ navigation }) {
  const [title, setTitle] = useState('');
  const [serviceType, setServiceType] = useState('');
  const [salary, setSalary] = useState('');
  const [city, setCity] = useState('');
  const [area, setArea] = useState('');
  const [description, setDescription] = useState('');
  const [workSchedule, setWorkSchedule] = useState('');

  const handleSubmit = async () => {
    if (!title || !serviceType || !salary || !city || !description) {
      Alert.alert('ุฎุทุฃ', 'ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ');
      return;
    }

    const postData = {
      title,
      service_type: serviceType,
      salary,
      city,
      area,
      description,
      work_schedule: workSchedule,
      user_id: 1 // ูุคูุช
    };

    const result = await api.post('/posts', postData);
    if (result) {
      Alert.alert('ูุฌุญ', 'ุชู ุฅูุดุงุก ุงูููุดูุฑ ุจูุฌุงุญ', [
        { text: 'ููุงูู', onPress: () => navigation.goBack() }
      ]);
    } else {
      Alert.alert('ุฎุทุฃ', 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูููุดูุฑ');
    }
  };

  return (
    <SafeAreaView style={styles.container}>
      <ScrollView style={styles.formContainer}>
        <Text style={styles.formTitle}>ุฅูุดุงุก ููุดูุฑ ุฌุฏูุฏ</Text>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ุนููุงู ุงูููุดูุฑ *</Text>
          <TextInput
            style={styles.input}
            value={title}
            onChangeText={setTitle}
            placeholder="ูุซุงู: ููุฑุจุงุฆู ูุญุชุฑู - ุฃุนูุงู ุงูุชูุฏูุฏุงุช ูุงูุตูุงูุฉ"
          />
        </View>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ููุน ุงูุฎุฏูุฉ *</Text>
          <TextInput
            style={styles.input}
            value={serviceType}
            onChangeText={setServiceType}
            placeholder="ูุซุงู: ููุฑุจุงุฆูุ ุณุจุงูุ ุทุจุงุฎ..."
          />
        </View>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ุงูุฑุงุชุจ ุงููุทููุจ *</Text>
          <TextInput
            style={styles.input}
            value={salary}
            onChangeText={setSalary}
            placeholder="ูุซุงู: 1500 ุฏููุงุฑ"
          />
        </View>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ุงููุฏููุฉ *</Text>
          <TextInput
            style={styles.input}
            value={city}
            onChangeText={setCity}
            placeholder="ูุซุงู: ุทุฑุงุจูุณุ ุจูุบุงุฒูุ ูุตุฑุงุชุฉ..."
          />
        </View>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ุงูููุทูุฉ</Text>
          <TextInput
            style={styles.input}
            value={area}
            onChangeText={setArea}
            placeholder="ูุซุงู: ุงูุฏููุงููุ ุงูููุทูุฉ ุงูุดุฑููุฉ..."
          />
        </View>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ููุน ุงูุฏูุงู</Text>
          <TextInput
            style={styles.input}
            value={workSchedule}
            onChangeText={setWorkSchedule}
            placeholder="ูุซุงู: ูุงููุ ุฌุฒุฆูุ ูุฑู..."
          />
        </View>

        <View style={styles.inputContainer}>
          <Text style={styles.inputLabel}>ูุตู ุงูุฎุฏูุฉ *</Text>
          <TextInput
            style={[styles.input, styles.textArea]}
            value={description}
            onChangeText={setDescription}
            placeholder="ุงูุชุจ ูุตูุงู ููุตูุงู ุนู ุฎุฏูุงุชู ูุฎุจุฑุงุชู..."
            multiline
            numberOfLines={4}
          />
        </View>

        <TouchableOpacity style={styles.submitButton} onPress={handleSubmit}>
          <Text style={styles.submitButtonText}>ูุดุฑ ุงูููุดูุฑ</Text>
        </TouchableOpacity>
      </ScrollView>
    </SafeAreaView>
  );
}

// ุดุงุดุฉ ุงูููู ุงูุดุฎุตู
function ProfileScreen() {
  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.profileContainer}>
        <View style={styles.profileHeader}>
          <View style={styles.avatar}>
            <Text style={styles.avatarText}>ุฃ</Text>
          </View>
          <Text style={styles.profileName}>ุฃุญูุฏ ุนูู</Text>
          <Text style={styles.profileType}>ุจุงุญุซ ุนู ุนูู</Text>
        </View>

        <View style={styles.profileStats}>
          <View style={styles.statItem}>
            <Text style={styles.statNumber}>4.8</Text>
            <Text style={styles.statLabel}>ุงูุชูููู</Text>
          </View>
          <View style={styles.statItem}>
            <Text style={styles.statNumber}>23</Text>
            <Text style={styles.statLabel}>ุงููุดุงุฑูุน</Text>
          </View>
          <View style={styles.statItem}>
            <Text style={styles.statNumber}>8</Text>
            <Text style={styles.statLabel}>ุณููุงุช ุงูุฎุจุฑุฉ</Text>
          </View>
        </View>

        <View style={styles.profileSection}>
          <Text style={styles.sectionTitle}>ูุจุฐุฉ ุนูู</Text>
          <Text style={styles.profileBio}>
            ููุฑุจุงุฆู ูุญุชุฑู ูุน ุฎุจุฑุฉ 8 ุณููุงุช ูู ุฌููุน ุฃููุงุน ุงูุฃุนูุงู ุงูููุฑุจุงุฆูุฉ
          </Text>
        </View>

        <TouchableOpacity style={styles.editButton}>
          <Text style={styles.editButtonText}>ุชุนุฏูู ุงูููู ุงูุดุฎุตู</Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
}

// ุงูุชููู ุงูุณููู
function MainTabs() {
  return (
    <Tab.Navigator
      screenOptions={{
        tabBarStyle: styles.tabBar,
        tabBarLabelStyle: styles.tabBarLabel,
        tabBarActiveTintColor: '#10B981',
        tabBarInactiveTintColor: '#6B7280',
        headerShown: false,
      }}
    >
      <Tab.Screen 
        name="Home" 
        component={HomeScreen} 
        options={{ tabBarLabel: 'ุงูุฑุฆูุณูุฉ' }}
      />
      <Tab.Screen 
        name="CreatePost" 
        component={CreatePostScreen} 
        options={{ tabBarLabel: 'ุฅูุดุงุก ููุดูุฑ' }}
      />
      <Tab.Screen 
        name="Profile" 
        component={ProfileScreen} 
        options={{ tabBarLabel: 'ุงูููู ุงูุดุฎุตู' }}
      />
    </Tab.Navigator>
  );
}

// ุงูุชุทุจูู ุงูุฑุฆูุณู
export default function App() {
  return (
    <NavigationContainer>
      <Stack.Navigator 
        initialRouteName="Login"
        screenOptions={{ headerShown: false }}
      >
        <Stack.Screen name="Login" component={LoginScreen} />
        <Stack.Screen name="MainTabs" component={MainTabs} />
      </Stack.Navigator>
    </NavigationContainer>
  );
}

// ุงูุฃููุงุท
const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F9FAFB',
  },
  
  // ุฃููุงุท ุชุณุฌูู ุงูุฏุฎูู
  loginContainer: {
    flexGrow: 1,
    justifyContent: 'center',
    padding: 20,
  },
  logoContainer: {
    alignItems: 'center',
    marginBottom: 40,
  },
  logoText: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#10B981',
    marginBottom: 8,
  },
  tagline: {
    fontSize: 16,
    color: '#6B7280',
    textAlign: 'center',
  },
  formContainer: {
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    padding: 24,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  formTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#1F2937',
    textAlign: 'center',
    marginBottom: 24,
  },
  inputContainer: {
    marginBottom: 16,
  },
  inputLabel: {
    fontSize: 14,
    fontWeight: '600',
    color: '#374151',
    marginBottom: 8,
  },
  input: {
    borderWidth: 1,
    borderColor: '#D1D5DB',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    backgroundColor: '#FFFFFF',
    textAlign: 'right',
  },
  textArea: {
    height: 100,
    textAlignVertical: 'top',
  },
  loginButton: {
    backgroundColor: '#10B981',
    borderRadius: 8,
    padding: 16,
    alignItems: 'center',
    marginTop: 8,
  },
  loginButtonText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },
  registerButton: {
    borderWidth: 1,
    borderColor: '#10B981',
    borderRadius: 8,
    padding: 16,
    alignItems: 'center',
    marginTop: 12,
  },
  registerButtonText: {
    color: '#10B981',
    fontSize: 16,
    fontWeight: '600',
  },
  guestButton: {
    backgroundColor: '#6B7280',
    borderRadius: 8,
    padding: 16,
    alignItems: 'center',
    marginTop: 12,
  },
  guestButtonText: {
    color: '#FFFFFF',
    fontSize: 14,
  },

  // ุฃููุงุท ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ
  header: {
    backgroundColor: '#FFFFFF',
    padding: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#E5E7EB',
  },
  headerTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#10B981',
    textAlign: 'center',
  },
  headerSubtitle: {
    fontSize: 14,
    color: '#6B7280',
    textAlign: 'center',
    marginTop: 4,
  },
  searchContainer: {
    padding: 16,
  },
  searchInput: {
    backgroundColor: '#FFFFFF',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    borderWidth: 1,
    borderColor: '#D1D5DB',
    textAlign: 'right',
  },
  quickActions: {
    flexDirection: 'row',
    paddingHorizontal: 16,
    marginBottom: 16,
    gap: 12,
  },
  actionButton: {
    flex: 1,
    padding: 16,
    borderRadius: 8,
    alignItems: 'center',
  },
  jobSeekerButton: {
    backgroundColor: '#10B981',
  },
  employerButton: {
    backgroundColor: '#3B82F6',
  },
  actionButtonText: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '600',
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#1F2937',
    paddingHorizontal: 16,
    marginBottom: 12,
  },
  postsList: {
    paddingHorizontal: 16,
  },
  postCard: {
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    padding: 16,
    marginBottom: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
    elevation: 2,
  },
  postHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: 8,
  },
  postTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#1F2937',
    flex: 1,
    marginRight: 8,
  },
  postSalary: {
    fontSize: 14,
    fontWeight: '600',
    color: '#10B981',
  },
  postService: {
    fontSize: 14,
    color: '#3B82F6',
    marginBottom: 4,
  },
  postLocation: {
    fontSize: 12,
    color: '#6B7280',
    marginBottom: 8,
  },
  postDescription: {
    fontSize: 14,
    color: '#4B5563',
    marginBottom: 12,
    lineHeight: 20,
  },
  postFooter: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 12,
  },
  postUser: {
    fontSize: 12,
    color: '#6B7280',
  },
  postSchedule: {
    fontSize: 12,
    color: '#6B7280',
  },
  contactButton: {
    backgroundColor: '#10B981',
    borderRadius: 6,
    padding: 8,
    alignItems: 'center',
  },
  contactButtonText: {
    color: '#FFFFFF',
    fontSize: 14,
    fontWeight: '600',
  },

  // ุฃููุงุท ุฅูุดุงุก ุงูููุดูุฑ
  submitButton: {
    backgroundColor: '#10B981',
    borderRadius: 8,
    padding: 16,
    alignItems: 'center',
    marginTop: 24,
    marginBottom: 32,
  },
  submitButtonText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },

  // ุฃููุงุท ุงูููู ุงูุดุฎุตู
  profileContainer: {
    flex: 1,
    padding: 20,
  },
  profileHeader: {
    alignItems: 'center',
    marginBottom: 32,
  },
  avatar: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: '#10B981',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 16,
  },
  avatarText: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#FFFFFF',
  },
  profileName: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#1F2937',
    marginBottom: 4,
  },
  profileType: {
    fontSize: 16,
    color: '#6B7280',
  },
  profileStats: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    padding: 20,
    marginBottom: 24,
  },
  statItem: {
    alignItems: 'center',
  },
  statNumber: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#10B981',
  },
  statLabel: {
    fontSize: 12,
    color: '#6B7280',
    marginTop: 4,
  },
  profileSection: {
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    padding: 20,
    marginBottom: 24,
  },
  profileBio: {
    fontSize: 14,
    color: '#4B5563',
    lineHeight: 20,
  },
  editButton: {
    backgroundColor: '#10B981',
    borderRadius: 8,
    padding: 16,
    alignItems: 'center',
  },
  editButtonText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },

  // ุฃููุงุท ุงูุชููู ุงูุณููู
  tabBar: {
    backgroundColor: '#FFFFFF',
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
    height: 60,
  },
  tabBarLabel: {
    fontSize: 12,
    fontWeight: '600',
  },
});

